<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="el"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ColumnDefinition.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SQLDomainGen</a> &gt; <a href="index.source.html" class="el_package">com.sqldomaingen.parser</a> &gt; <span class="el_source">ColumnDefinition.java</span></div><h1>ColumnDefinition.java</h1><pre class="source lang-java linenums">package com.sqldomaingen.parser;

import com.sqldomaingen.util.TypeMapper;
import com.sqldomaingen.model.Column;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import org.antlr.v4.runtime.Token;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Getter
<span class="pc" id="L13">@Setter</span>
<span class="fc" id="L14">@NoArgsConstructor</span>
public class ColumnDefinition {

<span class="fc" id="L17">    private static final Logger logger = LoggerFactory.getLogger(ColumnDefinition.class);</span>

<span class="fc" id="L19">    private String columnName;</span>
<span class="fc" id="L20">    private String sqlType;</span>
<span class="fc" id="L21">    private String javaType;</span>
<span class="fc" id="L22">    private int length;</span>
<span class="fc" id="L23">    private boolean primaryKey;</span>
<span class="fc" id="L24">    private boolean nullable = true;</span>
<span class="fc" id="L25">    private boolean unique;</span>
<span class="fc" id="L26">    private String defaultValue;</span>
<span class="fc" id="L27">    private String checkConstraint;</span>
<span class="fc" id="L28">    private String referencedTable;</span>
<span class="fc" id="L29">    private String referencedColumn;</span>
<span class="fc" id="L30">    private boolean foreignKey;</span>

    /**
     * Sets the column name based on the provided token.
     *
     * @param token the token containing column definition
     */
    public void setColumnNameFromToken(Token token) {
<span class="pc bpc" id="L38" title="2 of 4 branches missed.">        if (token != null &amp;&amp; token.getText() != null) {</span>
<span class="fc" id="L39">            String[] parts = token.getText().trim().split(&quot;\\s+&quot;);</span>
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">            this.columnName = parts.length &gt; 0 ? parts[0] : null;</span>
<span class="fc" id="L41">            logger.debug(&quot;Set columnName: {}&quot;, this.columnName);</span>
<span class="fc" id="L42">        } else {</span>
<span class="nc" id="L43">            logger.warn(&quot;Token is null or does not contain text.&quot;);</span>
        }
<span class="fc" id="L45">    }</span>

    /**
     * Sets the SQL type, derives the Java type, and extracts the length from the provided token.
     *
     * @param token the token containing SQL type information
     */
    public void setSqlTypeFromToken(Token token) {
<span class="pc bpc" id="L53" title="3 of 6 branches missed.">        if (token == null || token.getText() == null || token.getText().trim().isEmpty()) {</span>
<span class="nc" id="L54">            logger.warn(&quot;Token is null or does not contain valid text for SQL type. Defaulting sqlType to 'VARCHAR'.&quot;);</span>
<span class="nc" id="L55">            this.sqlType = &quot;VARCHAR&quot;;</span>
<span class="nc" id="L56">            this.javaType = TypeMapper.mapToJavaType(this.sqlType);</span>
<span class="nc" id="L57">            return;</span>
        }

        try {
            // Λήψη και καθαρισμός του SQL τύπου
<span class="fc" id="L62">            String text = token.getText().trim();</span>
<span class="fc" id="L63">            this.sqlType = extractSqlType(text); // Καθαρισμός τύπου</span>
<span class="fc" id="L64">            this.javaType = TypeMapper.mapToJavaType(this.sqlType); // Χαρτογράφηση σε Java τύπο</span>

<span class="fc" id="L66">            logger.debug(&quot;Set sqlType: {}, javaType: {}&quot;, this.sqlType, this.javaType);</span>
<span class="nc" id="L67">        } catch (Exception e) {</span>
<span class="nc" id="L68">            logger.error(&quot;Error while extracting SQL type from token: {}&quot;, token.getText(), e);</span>
<span class="nc" id="L69">            this.sqlType = &quot;VARCHAR&quot;;</span>
<span class="nc" id="L70">            this.javaType = TypeMapper.mapToJavaType(this.sqlType);</span>
<span class="fc" id="L71">        }</span>
<span class="fc" id="L72">    }</span>

    /**
     * Καθαρίζει τον SQL τύπο, αφαιρώντας constraints όπως (255).
     *
     * @param sqlTypeText το αρχικό κείμενο του SQL τύπου
     * @return ο καθαρός SQL τύπος
     */
    private String extractSqlType(String sqlTypeText) {
        // Αφαιρούμε constraints όπως (255) ή CHECK
<span class="fc" id="L82">        return sqlTypeText.replaceAll(&quot;\\([^)]*\\)&quot;, &quot;&quot;).trim().toUpperCase();</span>

    }




    /**
     * Determines if the column is a primary key based on the provided token.
     *
     * @param token the token containing column constraints
     */
    public void isPrimaryKey(Token token) {
<span class="pc bpc" id="L95" title="2 of 4 branches missed.">        if (token != null &amp;&amp; token.getText() != null) {</span>
<span class="fc" id="L96">            this.primaryKey = token.getText().toUpperCase().contains(&quot;PRIMARY KEY&quot;);</span>
<span class="fc" id="L97">            logger.debug(&quot;Set primaryKey: {}&quot;, this.primaryKey);</span>
        }
<span class="fc" id="L99">    }</span>

    /**
     * Determines if the column is nullable based on the provided token.
     *
     * @param token the token containing column constraints
     */
    public void isNullable(Token token) {
<span class="pc bpc" id="L107" title="2 of 4 branches missed.">        if (token != null &amp;&amp; token.getText() != null) {</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            this.nullable = !token.getText().toUpperCase().contains(&quot;NOT NULL&quot;);</span>
<span class="fc" id="L109">            logger.debug(&quot;Set nullable: {}&quot;, this.nullable);</span>
        }
<span class="fc" id="L111">    }</span>

    /**
     * Determines if the column is unique based on the provided token.
     *
     * @param token the token containing column constraints
     */
    public void isUnique(Token token) {
<span class="pc bpc" id="L119" title="2 of 4 branches missed.">        if (token != null &amp;&amp; token.getText() != null) {</span>
<span class="fc" id="L120">            this.unique = token.getText().toUpperCase().contains(&quot;UNIQUE&quot;);</span>
<span class="fc" id="L121">            logger.debug(&quot;Set unique: {}&quot;, this.unique);</span>
        }
<span class="fc" id="L123">    }</span>

    /**
     * Extracts and sets the default value from the provided token.
     *
     * @param token the token containing column constraints
     */
    public void isDefaultValue(Token token) {
<span class="pc bpc" id="L131" title="3 of 6 branches missed.">        if (token != null &amp;&amp; token.getText() != null &amp;&amp; token.getText().contains(&quot;DEFAULT&quot;)) {</span>
            try {
<span class="fc" id="L133">                String[] parts = token.getText().split(&quot;DEFAULT&quot;);</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">                if (parts.length &gt; 1) {</span>
<span class="fc" id="L135">                    this.defaultValue = parts[1].trim().split(&quot;\\s+&quot;)[0].replaceAll(&quot;[\&quot;']&quot;, &quot;&quot;);</span>
<span class="fc" id="L136">                    logger.debug(&quot;Set defaultValue: {}&quot;, this.defaultValue);</span>
                }
<span class="nc" id="L138">            } catch (Exception e) {</span>
<span class="nc" id="L139">                logger.warn(&quot;Error extracting default value from token: {}&quot;, token.getText(), e);</span>
<span class="fc" id="L140">            }</span>
        }
<span class="fc" id="L142">    }</span>

    /**
     * Sets the check constraint from the provided token.
     *
     * @param token the token containing column constraints
     */
    public void setCheckConstraint(Token token) {
<span class="pc bpc" id="L150" title="3 of 6 branches missed.">        if (token != null &amp;&amp; token.getText() != null &amp;&amp; token.getText().contains(&quot;CHECK&quot;)) {</span>
<span class="fc" id="L151">            int start = token.getText().indexOf(&quot;CHECK&quot;) + 5;</span>
<span class="fc" id="L152">            int openParen = token.getText().indexOf(&quot;(&quot;, start);</span>
<span class="fc" id="L153">            int closeParen = token.getText().lastIndexOf(&quot;)&quot;);</span>
<span class="pc bpc" id="L154" title="3 of 6 branches missed.">            if (openParen != -1 &amp;&amp; closeParen != -1 &amp;&amp; closeParen &gt; openParen) {</span>
<span class="fc" id="L155">                this.checkConstraint = token.getText().substring(openParen, closeParen + 1).trim();</span>
<span class="fc" id="L156">                logger.debug(&quot;Set checkConstraint: {}&quot;, this.checkConstraint);</span>
            }
        }
<span class="fc" id="L159">    }</span>

    /**
     * Determines if the column is a foreign key and sets the referenced table and column.
     *
     * @param token the token containing foreign key details
     */
    public void isForeignKey(Token token) {
<span class="pc bpc" id="L167" title="3 of 6 branches missed.">        if (token != null &amp;&amp; token.getText() != null &amp;&amp; token.getText().toUpperCase().contains(&quot;REFERENCES&quot;)) {</span>
            try {
<span class="fc" id="L169">                this.foreignKey = true;</span>
<span class="fc" id="L170">                String text = token.getText();</span>
<span class="fc" id="L171">                int refIndex = text.toUpperCase().indexOf(&quot;REFERENCES&quot;) + 10;</span>
<span class="fc" id="L172">                String[] parts = text.substring(refIndex).trim().split(&quot;\\s+|\\(&quot;);</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">                this.referencedTable = parts.length &gt; 0 ? parts[0] : null;</span>

<span class="fc" id="L175">                int openParen = text.indexOf(&quot;(&quot;);</span>
<span class="fc" id="L176">                int closeParen = text.indexOf(&quot;)&quot;);</span>
<span class="pc bpc" id="L177" title="3 of 6 branches missed.">                if (openParen != -1 &amp;&amp; closeParen != -1 &amp;&amp; closeParen &gt; openParen) {</span>
<span class="fc" id="L178">                    this.referencedColumn = text.substring(openParen + 1, closeParen).trim();</span>
                }

<span class="fc" id="L181">                logger.debug(&quot;Set foreignKey: {}, referencedTable: {}, referencedColumn: {}&quot;,</span>
<span class="fc" id="L182">                        this.foreignKey, this.referencedTable, this.referencedColumn);</span>
<span class="nc" id="L183">            } catch (Exception e) {</span>
<span class="nc" id="L184">                logger.warn(&quot;Error extracting foreign key details from token: {}&quot;, token.getText(), e);</span>
<span class="fc" id="L185">            }</span>
        }
<span class="fc" id="L187">    }</span>

    /**
     * Extracts the length of the column from the SQL type.
     *
     * @param sqlType the SQL type string
     * @return the length of the column
     */
    public static int extractLength(String sqlType) {
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (sqlType == null) {</span>
<span class="fc" id="L197">            return 255; // Default length</span>
        }

        try {
<span class="pc bpc" id="L201" title="1 of 4 branches missed.">            if (sqlType.contains(&quot;(&quot;) &amp;&amp; sqlType.contains(&quot;)&quot;)) {</span>
<span class="fc" id="L202">                String insideParentheses = sqlType.substring(sqlType.indexOf(&quot;(&quot;) + 1, sqlType.indexOf(&quot;)&quot;));</span>
<span class="fc" id="L203">                String[] parts = insideParentheses.split(&quot;,&quot;);</span>
<span class="fc" id="L204">                return Integer.parseInt(parts[0].trim());</span>
            }
<span class="fc" id="L206">        } catch (NumberFormatException e) {</span>
<span class="fc" id="L207">            logger.warn(&quot;Invalid length format in SQL type '{}'. Defaulting to 255.&quot;, sqlType);</span>
<span class="fc" id="L208">        }</span>
<span class="fc" id="L209">        return 255; // Default length for all other cases</span>
    }

    /**
     * Sets the referenced table from the provided token.
     *
     * @param token the token containing foreign key details
     */
    public void setReferencedTableFromToken(Token token) {
<span class="pc bpc" id="L218" title="3 of 6 branches missed.">        if (token != null &amp;&amp; token.getText() != null &amp;&amp; token.getText().toUpperCase().contains(&quot;REFERENCES&quot;)) {</span>
            try {
<span class="fc" id="L220">                String text = token.getText();</span>
<span class="fc" id="L221">                int refIndex = text.toUpperCase().indexOf(&quot;REFERENCES&quot;) + 10;</span>
<span class="fc" id="L222">                String[] parts = text.substring(refIndex).trim().split(&quot;\\s+|\\(&quot;);</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">                this.referencedTable = parts.length &gt; 0 ? parts[0] : null;</span>
<span class="fc" id="L224">                logger.debug(&quot;Set referencedTable: {}&quot;, this.referencedTable);</span>
<span class="nc" id="L225">            } catch (Exception e) {</span>
<span class="nc" id="L226">                logger.warn(&quot;Error extracting referenced table from token: {}&quot;, token.getText(), e);</span>
<span class="fc" id="L227">            }</span>
        }
<span class="fc" id="L229">    }</span>

    /**
     * Sets the referenced column from the provided token.
     *
     * @param token the token containing foreign key details
     */
    public void setReferencedColumnFromToken(Token token) {
<span class="pc bpc" id="L237" title="3 of 6 branches missed.">        if (token != null &amp;&amp; token.getText() != null &amp;&amp; token.getText().toUpperCase().contains(&quot;REFERENCES&quot;)) {</span>
            try {
<span class="fc" id="L239">                String text = token.getText();</span>
<span class="fc" id="L240">                int refIndex = text.toUpperCase().indexOf(&quot;REFERENCES&quot;) + 10;</span>
<span class="fc" id="L241">                int openParen = text.indexOf(&quot;(&quot;, refIndex);</span>
<span class="fc" id="L242">                int closeParen = text.indexOf(&quot;)&quot;, openParen);</span>
<span class="pc bpc" id="L243" title="3 of 6 branches missed.">                if (openParen != -1 &amp;&amp; closeParen != -1 &amp;&amp; closeParen &gt; openParen) {</span>
<span class="fc" id="L244">                    this.referencedColumn = text.substring(openParen + 1, closeParen).trim();</span>
<span class="fc" id="L245">                    logger.debug(&quot;Set referencedColumn: {}&quot;, this.referencedColumn);</span>
                }
<span class="nc" id="L247">            } catch (Exception e) {</span>
<span class="nc" id="L248">                logger.warn(&quot;Error extracting referenced column from token: {}&quot;, token.getText(), e);</span>
<span class="fc" id="L249">            }</span>
        }
<span class="fc" id="L251">    }</span>

    /**
     * Converts the ColumnDefinition to a Column object.
     *
     * @return the converted Column object
     */
    /**
     * Converts the ColumnDefinition to a Column object.
     *
     * @return the converted Column object
     */
    public Column toColumn() {
<span class="fc" id="L264">        logger.info(&quot;Converting ColumnDefinition to Column object...&quot;);</span>
<span class="fc" id="L265">        logger.debug(&quot;ColumnDefinition values: name={}, length={}, primaryKey={}, nullable={}, defaultValue={}, unique={}, checkConstraint={}, referencedTable={}, referencedColumn={}&quot;,</span>
<span class="fc" id="L266">                this.columnName, this.length, this.primaryKey, this.nullable, this.defaultValue, this.unique, this.checkConstraint, this.referencedTable, this.referencedColumn);</span>




<span class="fc" id="L271">        Column column = new Column();</span>
<span class="fc" id="L272">        column.setName(this.columnName);</span>
<span class="fc" id="L273">        column.setJavaType(this.javaType);</span>
<span class="fc" id="L274">        column.setLength(this.length);</span>
<span class="fc" id="L275">        column.setPrimaryKey(this.primaryKey);</span>
<span class="fc" id="L276">        column.setNullable(this.nullable);</span>
<span class="fc" id="L277">        column.setDefaultValue(this.defaultValue);</span>
<span class="fc" id="L278">        column.setUnique(this.unique);</span>
<span class="fc" id="L279">        column.setCheckConstraint(this.checkConstraint);</span>
<span class="fc" id="L280">        column.setReferencedTable(this.referencedTable);</span>
<span class="fc" id="L281">        column.setReferencedColumn(this.referencedColumn);</span>
<span class="fc" id="L282">        column.setSqlType(this.sqlType);</span>


        // Log the final Column object
<span class="fc" id="L286">        logger.debug(&quot;Converted Column: name={}, type={}, length={}, primaryKey={}, nullable={}, defaultValue={}, unique={}, checkConstraint={}, referencedTable={}, referencedColumn={}&quot;,</span>
<span class="fc" id="L287">                column.getName(), column.getJavaType(), column.getLength(), column.isPrimaryKey(), column.isNullable(), column.getDefaultValue(), column.isUnique(), column.getCheckConstraint(), column.getReferencedTable(), column.getReferencedColumn());</span>

<span class="fc" id="L289">        return column;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>